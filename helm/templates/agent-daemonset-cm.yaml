{{- $values := include "cloudzero-agent.values" . | fromYaml -}}
{{- if $values.defaults.federation.enabled -}}
apiVersion: v1
kind: ConfigMap
metadata:
  labels:
    {{- include "cloudzero-agent.server.labels" . | nindent 4 }}
  name: {{ .Release.Name }}-daemonset-cm
  namespace: {{ include "cloudzero-agent.namespace" . }}
  {{- include "cloudzero-agent.generateAnnotations" (merge $values.defaults.annotations $values.prometheusConfig.configMapAnnotations) | nindent 2 }}
data:
  prometheus.yml.in: |-
    {{- if and (not $values.defaults.federation.enabled) $values.prometheusConfig.configOverride }}
    {{ $values.prometheusConfig.configOverride | nindent 4 }}
    {{- else }}
    global:
      scrape_interval: {{ $values.prometheusConfig.globalScrapeInterval }}

    scrape_configs:
      {{- if $values.prometheusConfig.scrapeJobs.cadvisor.enabled }}
      {{- include "cloudzero-agent.prometheus.scrapeCAdvisor" (dict "root" . "scrapeLocalNodeOnly" true) | nindent 6 }}
      {{- end }}{{/* End cadvisor scrape job */}}

      {{- if $values.prometheusConfig.scrapeJobs.prometheus.enabled }}
      {{- include "cloudzero-agent.prometheus.scrapePrometheus" . | nindent 6 }}
      {{- end }}
    {{- end}}

    {{- include "cloudzero-agent.aggregator.remoteWrite" . | nindent 4 }}
{{- end }}
